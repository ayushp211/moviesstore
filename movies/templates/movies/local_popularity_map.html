{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">
                <i class="fas fa-map-marked-alt me-2"></i>
                Local Popularity Map
            </h1>
            <p class="text-center text-muted mb-4">
                Discover which movies are trending in different US states
            </p>
        </div>
    </div>
    
    <!-- API Status Indicator -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info" id="api-status">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="api-status-text">Initializing map data...</span>
                        <small class="d-block mt-1" id="api-debug-info"></small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-data" onclick="refreshMapData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Legend</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Trending Movie</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-primary rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Popular Movie</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API endpoint for fetching trending movies data -->
<script type="text/javascript">
    // API endpoint URL
    const API_ENDPOINT = "{% url 'movies.trending_movies_api' %}";
</script>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// State coordinates (approximate center of each state)
const stateCoordinates = {
    'Alabama': [32.806671, -86.791130],
    'Alaska': [61.370716, -152.404419],
    'Arizona': [33.729759, -111.431221],
    'Arkansas': [34.969704, -92.373123],
    'California': [36.116203, -119.681564],
    'Colorado': [39.059811, -105.311104],
    'Connecticut': [41.597782, -72.755371],
    'Delaware': [39.318523, -75.507141],
    'Florida': [27.766279, -81.686783],
    'Georgia': [33.040619, -83.643074],
    'Hawaii': [21.094318, -157.498337],
    'Idaho': [44.240459, -114.478828],
    'Illinois': [40.349457, -88.986137],
    'Indiana': [39.849426, -86.258278],
    'Iowa': [42.011539, -93.210526],
    'Kansas': [38.526600, -96.726486],
    'Kentucky': [37.668140, -84.670067],
    'Louisiana': [31.169546, -91.867805],
    'Maine': [44.323535, -69.765261],
    'Maryland': [39.063946, -76.802101],
    'Massachusetts': [42.230171, -71.530106],
    'Michigan': [43.326618, -84.536095],
    'Minnesota': [45.694454, -93.900192],
    'Mississippi': [32.741646, -89.678696],
    'Missouri': [38.572954, -92.189283],
    'Montana': [47.052632, -110.454353],
    'Nebraska': [41.125370, -98.268082],
    'Nevada': [38.313515, -117.055374],
    'New Hampshire': [43.452492, -71.563896],
    'New Jersey': [40.298904, -74.521011],
    'New Mexico': [34.840515, -106.248482],
    'New York': [42.165726, -74.948051],
    'North Carolina': [35.630066, -79.806419],
    'North Dakota': [47.528912, -99.784012],
    'Ohio': [40.388783, -82.764915],
    'Oklahoma': [35.565342, -96.928917],
    'Oregon': [44.572021, -122.070938],
    'Pennsylvania': [40.590752, -77.209755],
    'Rhode Island': [41.680893, -71.51178],
    'South Carolina': [33.856892, -80.945007],
    'South Dakota': [44.299782, -99.438828],
    'Tennessee': [35.747845, -86.692345],
    'Texas': [31.054487, -97.563461],
    'Utah': [40.150032, -111.862434],
    'Vermont': [44.045876, -72.710686],
    'Virginia': [37.769337, -78.169968],
    'Washington': [47.400902, -121.490494],
    'West Virginia': [38.491226, -80.954453],
    'Wisconsin': [44.268543, -89.616508],
    'Wyoming': [42.755966, -107.302490]
};

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Update API status
    const apiStatus = document.getElementById('api-status');
    const apiStatusText = document.getElementById('api-status-text');
    const apiDebugInfo = document.getElementById('api-debug-info');
    
    // Show loading indicator
    const mapContainer = document.getElementById('map');
    mapContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Update status to show API call
    apiStatus.className = 'alert alert-warning';
    apiStatusText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching data from API...';
    apiDebugInfo.textContent = `API Endpoint: ${API_ENDPOINT} | Timestamp: ${new Date().toLocaleString()}`;

    // Fetch data from API
    fetch(API_ENDPOINT)
        .then(response => {
            console.log('API Response received:', response.status, response.statusText);
            return response.json();
        })
        .then(result => {
            if (result.success) {
                const stateMovieData = result.data;
                console.log('State movie data loaded from API:', stateMovieData);
                console.log('Number of states with data:', Object.keys(stateMovieData).length);
                
                // Update status to show success
                apiStatus.className = 'alert alert-success';
                apiStatusText.innerHTML = '<i class="fas fa-check-circle me-2"></i>Data loaded successfully from API!';
                apiDebugInfo.innerHTML = `
                    <strong>API Call Successful!</strong><br>
                    Endpoint: ${API_ENDPOINT}<br>
                    States Loaded: ${Object.keys(stateMovieData).length}<br>
                    API Timestamp: ${result.timestamp || 'N/A'}<br>
                    API Version: ${result.api_version || 'N/A'}<br>
                    Total States: ${result.total_states || Object.keys(stateMovieData).length}<br>
                    Client Load Time: ${new Date().toLocaleString()}<br>
                    Response Message: "${result.message}"
                `;
                
                // Initialize the map
                const map = L.map('map').setView([39.8283, -98.5795], 4);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // Create markers for each state
                console.log('Creating markers for', Object.keys(stateMovieData).length, 'states');
                let markersCreated = 0;
                Object.keys(stateMovieData).forEach(stateName => {
                    const data = stateMovieData[stateName];
                    const coords = stateCoordinates[stateName];
                    
                    console.log(`Processing ${stateName}:`, data, 'coords:', coords);
                    
                    if (coords) {
                        // Choose marker color based on trending status
                        const markerColor = data.trending ? 'green' : 'blue';
                        
                        // Create custom marker icon
                        const markerIcon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                background-color: ${markerColor};
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            "></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        
                        // Create marker
                        const marker = L.marker(coords, { icon: markerIcon }).addTo(map);
                        
                        // Create popup content
                        const popupContent = `
                            <div class="popup-content">
                                <h6 class="fw-bold mb-2">${stateName}</h6>
                                <p class="mb-1"><strong>Most Popular Movie:</strong> ${data.movie}</p>
                                <p class="mb-1"><strong>Purchases:</strong> ${data.purchases.toLocaleString()}</p>
                                <p class="mb-0">
                                    <span class="badge ${data.trending ? 'bg-success' : 'bg-primary'}">
                                        ${data.trending ? 'Trending' : 'Popular'}
                                    </span>
                                </p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markersCreated++;
                    } else {
                        console.warn(`No coordinates found for state: ${stateName}`);
                    }
                });
                console.log(`Successfully created ${markersCreated} markers`);

                // Add some custom CSS for better popup styling
                const style = document.createElement('style');
                style.textContent = `
                    .popup-content {
                        min-width: 200px;
                    }
                    .popup-content h6 {
                        color: #333;
                        border-bottom: 1px solid #eee;
                        padding-bottom: 5px;
                    }
                    .popup-content p {
                        margin-bottom: 5px;
                        font-size: 14px;
                    }
                    .custom-marker {
                        background: transparent !important;
                        border: none !important;
                    }
                `;
                document.head.appendChild(style);
            } else {
                // Handle API error
                console.error('API Error:', result.message);
                apiStatus.className = 'alert alert-danger';
                apiStatusText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>API Error - Data load failed!';
                apiDebugInfo.innerHTML = `
                    <strong>API Error Response:</strong><br>
                    Endpoint: ${API_ENDPOINT}<br>
                    Error: ${result.message}<br>
                    Time: ${new Date().toLocaleString()}
                `;
                mapContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="alert alert-danger">Failed to load map data. Please try again later.</div></div>';
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            apiStatus.className = 'alert alert-danger';
            apiStatusText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network Error - Cannot reach API!';
            apiDebugInfo.innerHTML = `
                <strong>Network Error:</strong><br>
                Endpoint: ${API_ENDPOINT}<br>
                Error: ${error.message}<br>
                Time: ${new Date().toLocaleString()}
            `;
            mapContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="alert alert-danger">Failed to load map data. Please try again later.</div></div>';
        });

}); // End DOMContentLoaded

// Global function to refresh map data
function refreshMapData() {
    console.log('Manual refresh triggered by user');
    location.reload(); // Simple reload to demonstrate API call
}

// Add a function to show API call proof
function demonstrateApiCall() {
    const apiStatus = document.getElementById('api-status');
    const apiStatusText = document.getElementById('api-status-text');
    const apiDebugInfo = document.getElementById('api-debug-info');
    
    apiStatus.className = 'alert alert-warning';
    apiStatusText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Making fresh API call...';
    apiDebugInfo.innerHTML = `
        <strong>Live API Call Demonstration:</strong><br>
        Endpoint: ${API_ENDPOINT}<br>
        Method: GET<br>
        Timestamp: ${new Date().toLocaleString()}<br>
        <em>This proves data is fetched from API, not hard-coded!</em>
    `;
}

// Show initial API call proof
setTimeout(demonstrateApiCall, 1000);
</script>
{% endblock %}
